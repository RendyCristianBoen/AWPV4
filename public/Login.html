<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Sistem Informasi Perpustakaan</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <link rel="stylesheet" href="css/Style.css">
</head>
<body>
    <!-- NAVIGATION - FIXED -->
    <nav>
        <ul>
            <li data-page="home"><a href="/">ğŸ  Home</a></li>
            <li data-page="about"><a href="/about">â„¹ï¸ About</a></li>

            <!-- Navigation untuk user yang belum login -->
            <li id="nav-login" class="nav-fade">
                <a href="/login">ğŸšª Login</a>
            </li>
            <li id="nav-register" class="nav-fade">
                <a href="/register">ğŸ“ Daftar</a>
            </li>

            <!-- Navigation untuk user yang sudah login -->
            <li id="nav-username" class="nav-fade"></li>
            <li id="nav-logout" class="nav-fade">
                <a href="#" id="logout-link">ğŸšª Logout</a>
            </li>
        </ul>
    </nav>

    <div class="toggle-container">
        <button id="mode-toggle" aria-label="Toggle mode gelap/terang">ğŸŒ“ Mode Gelap</button>
    </div>

    <!-- HERO SECTION -->
    <div class="login-hero">
        <div class="hero-content">
            <h1>ğŸ“š Selamat Datang di Perpustakaan Digital</h1>
            <p>Jelajahi dunia pengetahuan dengan koleksi 100+ buku berkualitas</p>
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number">100+</span>
                    <span class="stat-label">Buku Lengkap</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">8+</span>
                    <span class="stat-label">Genre Beragam</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">â­ 4.5+</span>
                    <span class="stat-label">Rating Tinggi</span>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN CONTAINER -->
    <div class="login-container-wide">
        <div class="login-card">
            <div class="login-header">
                <h2>ğŸ” Login Sistem Perpustakaan</h2>
                <p>Masuk untuk mengakses koleksi buku lengkap</p>
            </div>

            <form id="loginForm" class="wide-form">
                <div class="form-row">
                    <div class="form-group-wide">
                        <label for="username">ğŸ‘¤ Username:</label>
                        <input type="text" id="username" name="username" required placeholder="Masukkan username Anda" />
                        <div class="error-message" id="usernameError"></div>
                    </div>

                    <div class="form-group-wide">
                        <label for="password">ğŸ”’ Password:</label>
                        <input type="password" id="password" name="password" required placeholder="Masukkan password Anda" />
                        <div class="error-message" id="passwordError"></div>
                    </div>
                </div>

                <button type="submit" class="login-btn-wide">ğŸš€ Login Sekarang</button>

                <div class="register-link-container">
                    <p class="register-link-text">Belum punya akun? 
                    <a href="/register" class="register-link">ğŸ“ Daftar di sini</a>
                    </p>
                </div>
            </form>

            <!-- Info pengguna: untuk akses sebagai pengguna, silakan daftar terlebih dahulu. -->
            <p class="text-center" >
                <strong>Untuk akses sebagai pengguna, silakan daftar terlebih dahulu.</strong>
            </p>
        </div>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        function showNotification(message, type = 'success') {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: 'top',
                position: 'right',
                backgroundColor: type === 'success' 
                    ? 'linear-gradient(135deg, #28a745, #20c997)'
                    : 'linear-gradient(135deg, #dc3545, #e83e8c)',
                stopOnFocus: true,
            }).showToast();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            // Reset error messages
            document.getElementById('usernameError').style.display = 'none';
            document.getElementById('passwordError').style.display = 'none';

            // Basic validation
            if (!username) {
                document.getElementById('usernameError').textContent = 'Username tidak boleh kosong.';
                document.getElementById('usernameError').style.display = 'block';
                return;
            }
            if (!password) {
                document.getElementById('passwordError').textContent = 'Password tidak boleh kosong.';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }

            try {
                console.log('Attempting login with:', { username, password });

                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        username: username,
                        password: password 
                    }),
                });

                console.log('Response status:', response.status);
                
                // Handle different status codes properly
                if (response.status === 400) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Bad request');
                }
                
                if (response.status === 401) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.message || 'Unauthorized');
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Login result:', result);

                if (result.success) {
                    // Simpan data ke localStorage dengan delay untuk memastikan tersimpan
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('userRole', result.user.role);
                    localStorage.setItem('userName', result.user.nama);
                    localStorage.setItem('userId', result.user.id);
                    
                    console.log('Login successful, localStorage updated:', {
                        isLoggedIn: localStorage.getItem('isLoggedIn'),
                        userName: localStorage.getItem('userName'),
                        userRole: localStorage.getItem('userRole')
                    });
                    
                    showNotification('ğŸ‰ Login berhasil! Selamat datang ' + result.user.nama, 'success');
                    
                    // Success animation
                    const submitButton = document.querySelector('.login-btn-wide');
                    submitButton.textContent = 'âœ… Login Berhasil!';
                    submitButton.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                    submitButton.disabled = true;
                    
                    // Redirect ke home page setelah login berhasil
                    setTimeout(() => {
                        console.log('Redirecting to home page...');
                        window.location.href = '/';
                    }, 1500);
                } else {
                    const errorElement = document.getElementById('passwordError');
                    errorElement.textContent = result.message || 'Login gagal';
                    errorElement.style.display = 'block';
                    showNotification('âŒ ' + (result.message || 'Login gagal'), 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                const errorElement = document.getElementById('passwordError');
                errorElement.textContent = 'Terjadi kesalahan saat login: ' + error.message;
                errorElement.style.display = 'block';
                showNotification('âŒ Terjadi kesalahan saat login: ' + error.message, 'error');
            }
        });

        // Dark mode ditangani terpusat oleh app.js (attachModeToggle)
        // Tidak perlu handler duplikat di halaman ini.

        // NAV: Saat belum login, tampilkan hanya About + Login/Daftar
        function updateNav() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            
            console.log('=== LOGIN PAGE NAV UPDATE ===');
            console.log('Login page - isLoggedIn:', isLoggedIn);
            console.log('Login page - localStorage:', {
                isLoggedIn: localStorage.getItem('isLoggedIn'),
                userName: localStorage.getItem('userName'),
                userRole: localStorage.getItem('userRole'),
                userId: localStorage.getItem('userId')
            });
            
            const navUsername = document.getElementById('nav-username');
            const navLogout = document.getElementById('nav-logout');
            const navLogin = document.getElementById('nav-login');
            const navRegister = document.getElementById('nav-register');
            const navItems = document.querySelectorAll('nav ul li');

            // Reset tampil
            navItems.forEach(item => item.style.display = 'flex');

            if (isLoggedIn) {
                const userName = localStorage.getItem('userName');
                const userRole = localStorage.getItem('userRole');
                console.log('Login page - user is logged in, showing logged-in nav');
                
                if (navUsername) {
                    navUsername.style.display = 'flex';
                    navUsername.textContent = `ğŸ‘‹ Halo, ${userName} (${userRole})`;
                }
                if (navLogout) navLogout.style.display = 'flex';
                if (navLogin) navLogin.style.display = 'none';
                if (navRegister) navRegister.style.display = 'none';
                
                // Jika user sudah login dan berada di halaman login, redirect ke home
                console.log('Login page - user already logged in, redirecting to home...');
                setTimeout(() => {
                    console.log('Login page - executing redirect to home');
                    window.location.href = '/';
                }, 1000);
            } else {
                console.log('Login page - user is not logged in, showing guest nav');
                // Sembunyikan Home/Dashboard/Catalog/LoanHistory
                document.querySelectorAll('nav [data-page="home"], nav [data-page="dashboard"], nav [data-page="catalog"], nav [data-page="loan-history"]').forEach(el => el.style.display = 'none');
                if (navUsername) navUsername.style.display = 'none';
                if (navLogout) navLogout.style.display = 'none';
                if (navLogin) navLogin.style.display = 'flex';
                if (navRegister) navRegister.style.display = 'flex';
            }

            // Sembunyikan link halaman saat ini (Login) jika ada
            const currentItem = document.querySelector('nav [href="/login"]')?.parentElement;
            if (currentItem) currentItem.style.display = 'none';
            
            console.log('=== LOGIN PAGE NAV UPDATE COMPLETE ===');
        }

        async function handleLogout(event) {
            event.preventDefault();
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                });
                const result = await response.json();
                if (result.success) {
                    localStorage.clear();
                    showNotification('ğŸ‘‹ Anda telah berhasil logout.', 'success');
                    // // window.location.href = '/login'; // Disabled for testing // Disabled for testing
                } else {
                    showNotification('âŒ Gagal logout: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error during logout:', error);
                showNotification('âŒ Terjadi kesalahan saat logout.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateNav();

            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.addEventListener('click', handleLogout);
            }

            // Animation for input focus
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('focused');
                });
                input.addEventListener('blur', function() {
                    if (!this.value) {
                        this.parentElement.classList.remove('focused');
                    }
                });
            });

            // Auto-focus on username field
            document.getElementById('username').focus();

            // Enter key for form submission
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                }
            });

        });
    </script>
    <script src="js/app.js?v=20241220"></script>
</body>
</html>
