<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Sistem Informasi Perpustakaan</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <link rel="stylesheet" href="css/Style.css">
</head>
<body>
  <!-- NAVIGATION -->
  <nav>
    <ul>
      <li data-page="home"><a href="/">ğŸ  Home</a></li>
      <li data-page="about"><a href="/about">â„¹ï¸ About</a></li>

      <!-- Guest -->
      <li id="nav-login"><a href="/login">ğŸšª Login</a></li>
      <li id="nav-register"><a href="/register">ğŸ“ Daftar</a></li>

      <!-- Logged-in -->
      <li id="nav-username" ></li>
      <li id="nav-logout" ><a href="#" id="logout-link">ğŸšª Logout</a></li>
    </ul>
  </nav>

  <div class="toggle-container">
    <button id="mode-toggle" aria-label="Toggle mode">ğŸŒ“ Mode Gelap</button>
  </div>

  <!-- LOGIN -->
  <div class="login-container-wide">
    <div class="login-card">
      <div class="login-header">
        <h2>ğŸ” Login Sistem Perpustakaan</h2>
        <p>Masuk untuk mengakses koleksi buku lengkap</p>
      </div>

      <form id="loginForm" class="wide-form">
        <div class="form-row">
          <div class="form-group-wide">
            <label for="username">ğŸ‘¤ Username:</label>
            <input type="text" id="username" name="username" required placeholder="Masukkan username Anda" />
            <div class="error-message" id="usernameError"></div>
          </div>

          <div class="form-group-wide">
            <label for="password">ğŸ”’ Password:</label>
            <input type="password" id="password" name="password" required placeholder="Masukkan password Anda" />
            <div class="error-message" id="passwordError"></div>
          </div>
        </div>

        <button type="submit" class="login-btn-wide">ğŸš€ Login Sekarang</button>

        <div class="register-link-container">
          <p class="register-link-text">
            Belum punya akun?
            <a href="/register" class="register-link">ğŸ“ Daftar di sini</a>
          </p>
        </div>
      </form>

      <p class="text-center">
        <strong>Untuk akses sebagai pengguna, silakan daftar terlebih dahulu.</strong>
      </p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
    function showNotification(message, type = 'success') {
      Toastify({
        text: message,
        duration: 3000,
        close: true,
        gravity: 'top',
        position: 'right',
        backgroundColor: type === 'success'
          ? 'linear-gradient(135deg, #28a745, #20c997)'
          : 'linear-gradient(135deg, #dc3545, #e83e8c)',
      }).showToast();
    }

    // LOGIN HANDLER
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username) {
        document.getElementById('usernameError').textContent = 'Username tidak boleh kosong.';
        document.getElementById('usernameError').style.display = 'block';
        return;
      }
      if (!password) {
        document.getElementById('passwordError').textContent = 'Password tidak boleh kosong.';
        document.getElementById('passwordError').style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password }),
        });

        const result = await response.json();
        console.log('Login result:', result);

        if (response.ok && result.success) {
          // Simpan status login
          localStorage.setItem('isLoggedIn', 'true');
          localStorage.setItem('userRole', result.user.role);
          localStorage.setItem('userName', result.user.nama);
          localStorage.setItem('userId', result.user.id);

          showNotification('ğŸ‰ Login berhasil! Selamat datang ' + result.user.nama, 'success');

          const btn = document.querySelector('.login-btn-wide');
          btn.textContent = 'âœ… Login Berhasil!';
          btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
          btn.disabled = true;

          // Redirect ke home
          setTimeout(() => {
            console.log('Redirecting to home...');
            window.location.href = '/';
          }, 1500);
        } else {
          document.getElementById('passwordError').textContent =
            result.message || 'Login gagal. Periksa kembali username dan password.';
          document.getElementById('passwordError').style.display = 'block';
          showNotification('âŒ ' + (result.message || 'Login gagal'), 'error');
        }
      } catch (err) {
        console.error('Login error:', err);
        showNotification('âŒ Terjadi kesalahan saat login: ' + err.message, 'error');
      }
    });

    // LOGOUT
    async function handleLogout(e) {
      e.preventDefault();
      try {
        const response = await fetch('/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
        });
        const result = await response.json();
        if (result.success) {
          localStorage.clear();
          showNotification('ğŸ‘‹ Anda telah logout.', 'success');
          setTimeout(() => (window.location.href = '/login'), 1000);
        }
      } catch (error) {
        console.error('Logout error:', error);
        showNotification('âŒ Gagal logout', 'error');
      }
    }

    // UPDATE NAV SESUAI STATUS LOGIN
    function updateNav() {
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      const userName = localStorage.getItem('userName');
      const userRole = localStorage.getItem('userRole');

      console.log('Login page - updateNav:', { isLoggedIn, userName, userRole });

      const navUsername = document.getElementById('nav-username');
      const navLogout = document.getElementById('nav-logout');
      const navLogin = document.getElementById('nav-login');
      const navRegister = document.getElementById('nav-register');

      if (isLoggedIn) {
        if (navUsername) {
          navUsername.textContent = `ğŸ‘‹ Halo, ${userName} (${userRole})`;
          navUsername.style.display = 'flex';
        }
        if (navLogout) navLogout.style.display = 'flex';
        if (navLogin) navLogin.style.display = 'none';
        if (navRegister) navRegister.style.display = 'none';

        // Kalau udah login dan buka /login, langsung ke home
        console.log('User already logged in, redirecting to home in 3 seconds...');
        setTimeout(() => {
          console.log('Executing redirect to home');
          window.location.href = '/';
        }, 3000);
      } else {
        if (navUsername) navUsername.style.display = 'none';
        if (navLogout) navLogout.style.display = 'none';
        if (navLogin) navLogin.style.display = 'flex';
        if (navRegister) navRegister.style.display = 'flex';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Login page DOM loaded');
      updateNav();
      document.getElementById('logout-link')?.addEventListener('click', handleLogout);
    });
  </script>

  <!-- Script utama -->
  <script src="/app.js"></script>
</body>
</html>